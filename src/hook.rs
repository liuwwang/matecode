//! src/hook.rs

use crate::git::run_git_command;
use anyhow::{anyhow, Result};
use std::env;
use std::fs;
use std::os::unix::fs::PermissionsExt;
use std::path::PathBuf;

fn get_hooks_dir() -> Result<PathBuf> {
    let git_dir_output = run_git_command(&["rev-parse", "--git-dir"])?;
    let git_dir = String::from_utf8(git_dir_output.stdout)?.trim().to_string();
    let hooks_dir = PathBuf::from(git_dir).join("hooks");
    fs::create_dir_all(&hooks_dir)?;
    Ok(hooks_dir)
}

pub fn install_post_commit_hook() -> Result<()> {
    let hooks_dir = get_hooks_dir()?;
    let hook_path = hooks_dir.join("post-commit");

    // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœå­˜åœ¨ä¸€ä¸ªä¸å±äº matecode çš„é’©å­ï¼Œåˆ™ä¸­æ­¢
    if hook_path.exists() {
        let existing_content = fs::read_to_string(&hook_path)?;
        if !existing_content.contains("matecode archive") {
            println!(
                "âš ï¸  æ£€æµ‹åˆ°å·²å­˜åœ¨çš„ post-commit é’©å­ï¼Œä½†å†…å®¹ä¸ matecode æ— å…³ã€‚\nä¸ºé¿å…è¦†ç›–ç°æœ‰é€»è¾‘ï¼Œå®‰è£…å·²ä¸­æ­¢ã€‚"
            );
            println!(
                "ğŸ‘‰ è¯·æ‰‹åŠ¨å°† `matecode archive` å‘½ä»¤æ·»åŠ åˆ°æ‚¨çš„ {} æ–‡ä»¶ä¸­ã€‚",
                hook_path.display()
            );
            return Ok(());
        }
    }

    // è·å– matecode çš„ç»å¯¹è·¯å¾„
    let matecode_path = env::current_exe()?;
    let matecode_path_str = matecode_path
        .to_str()
        .ok_or_else(|| anyhow!("æ— æ³•è·å– matecode å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„"))?;

    let hook_script_content = format!(
        r#"#!/bin/sh
# matecode post-commit hook
# This script is auto-generated by `matecode install-hook`.

# ä½¿ç”¨ç»å¯¹è·¯å¾„è°ƒç”¨ matecodeï¼Œä»¥ç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½æ‰¾åˆ°
"{}" archive
"#,
        matecode_path_str
    );

    fs::write(&hook_path, hook_script_content)?;

    // åœ¨ Unix ç³»ç»Ÿä¸Šï¼Œèµ‹äºˆæ‰§è¡Œæƒé™
    #[cfg(unix)]
    {
        let mut perms = fs::metadata(&hook_path)?.permissions();
        perms.set_mode(0o755); // rwxr-xr-x
        fs::set_permissions(&hook_path, perms)?;
    }

    println!("âœ… post-commit é’©å­å·²æˆåŠŸå®‰è£…åˆ° {}", hook_path.display());

    Ok(())
} 